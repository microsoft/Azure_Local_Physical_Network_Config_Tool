{#
  QoS Configuration for Cisco NX-OS
  
  Configures DCB (Data Center Bridging) for RDMA/RoCEv2 traffic.
  Only renders if ANY interface has qos: true.
  
  Azure Local Requirements:
  - PFC (Priority Flow Control) on CoS 3 for RDMA
  - Bandwidth allocation: 50% RDMA, 48% default, 2% cluster
  - MTU 9216 for jumbo frames
#}
{% if has_qos_interfaces -%}
! === QOS CONFIGURATION ===
! DCB/PFC for Azure Local RDMA traffic

{# -------- Network QoS Class Maps -------- #}
class-map type network-qos AZLOCAL-NWQOS-RDMA
  match qos-group 3
class-map type network-qos AZLOCAL-NWQOS-CLUSTER
  match qos-group 7
class-map type network-qos AZLOCAL-NWQOS-DEFAULT
  match qos-group 0

{# -------- Network QoS Policy: MTU and PFC -------- #}
policy-map type network-qos AZLOCAL-NWQOS
  class type network-qos AZLOCAL-NWQOS-RDMA
    pause pfc-cos 3
    mtu 9216
  class type network-qos AZLOCAL-NWQOS-CLUSTER
    mtu 9216
  class type network-qos AZLOCAL-NWQOS-DEFAULT
    mtu 9216

{# -------- QoS Classification: Match incoming CoS -------- #}
class-map type qos match-all AZLOCAL-QOS-RDMA
  match cos 3
class-map type qos match-all AZLOCAL-QOS-CLUSTER
  match cos 7

policy-map type qos AZLOCAL-QOS-MAP
  class AZLOCAL-QOS-RDMA
    set qos-group 3
  class AZLOCAL-QOS-CLUSTER
    set qos-group 7

{# -------- Queuing Policy: Bandwidth allocation -------- #}
{# 50% RDMA (queue 3), 48% default, 2% cluster (queue 7) #}
policy-map type queuing AZLOCAL-QUEUE-OUT
  class type queuing c-out-8q-q3
    bandwidth remaining percent 50
    random-detect minimum-threshold 300 kbytes maximum-threshold 300 kbytes drop-probability 100 weight 0 ecn
  class type queuing c-out-8q-q-default
    bandwidth remaining percent 48
  class type queuing c-out-8q-q7
    bandwidth percent 2

{# -------- System QoS: Bind policies globally -------- #}
system qos
  service-policy type network-qos AZLOCAL-NWQOS
  service-policy type queuing output AZLOCAL-QUEUE-OUT
{%- endif %}
