{#
  Interface Configuration for Cisco NX-OS
  
  Configures physical interfaces including:
  - Access ports
  - Trunk ports (with QoS for RDMA)
  - L3 routed interfaces
  - Loopback interfaces
#}
{% if has_interfaces -%}
! === INTERFACE CONFIGURATION ===

{# -------- Loopback Interfaces -------- #}
{% for iface in interfaces if iface.intf_type | lower == "loopback" %}
interface loopback{{ iface.intf }}
  description {{ iface.name }}
  ip address {{ iface.ipv4 }}
{% if iface.shutdown is defined and iface.shutdown %}
  shutdown
{% else %}
  no shutdown
{% endif %}

{% endfor %}

{# -------- L3 Routed Interfaces -------- #}
{% for iface in interfaces if iface.type == "L3" and iface.intf_type | lower == "ethernet" %}
{% set intf_range = iface.intf if iface.intf is defined else iface.start_intf ~ (('-' ~ iface.end_intf) if iface.end_intf is defined and iface.end_intf != iface.start_intf else '') %}
interface Ethernet{{ intf_range }}
  description {{ iface.name }}
  no cdp enable
  no switchport
  ip address {{ iface.ipv4 }}
  no ip redirects
  no ipv6 redirects
  mtu 9216
{% if iface.shutdown is defined and iface.shutdown %}
  shutdown
{% else %}
  no shutdown
{% endif %}

{% endfor %}

{# -------- Access Interfaces -------- #}
{% for iface in interfaces if iface.type == "Access" %}
{% set intf_range = iface.intf if iface.intf is defined else iface.start_intf ~ (('-' ~ iface.end_intf) if iface.end_intf is defined and iface.end_intf != iface.start_intf else '') %}
interface Ethernet{{ intf_range }}
  description {{ iface.name }}
  no cdp enable
  switchport
  switchport mode access
  switchport access vlan {{ iface.access_vlan }}
  spanning-tree port type edge
  no logging event port link-status
  mtu 9216
{% if iface.qos is defined and iface.qos %}
  service-policy type qos input AZLOCAL-QOS-MAP
{% endif %}
{% if iface.shutdown is defined and iface.shutdown %}
  shutdown
{% else %}
  no shutdown
{% endif %}

{% endfor %}

{# -------- Trunk Interfaces -------- #}
{% for iface in interfaces if iface.type == "Trunk" %}
{% set intf_range = iface.intf if iface.intf is defined else iface.start_intf ~ (('-' ~ iface.end_intf) if iface.end_intf is defined and iface.end_intf != iface.start_intf else '') %}
interface Ethernet{{ intf_range }}
  description {{ iface.name }}
  no cdp enable
  switchport
  switchport mode trunk
  switchport trunk native vlan {{ iface.native_vlan }}
{% if iface.tagged_vlans is defined and iface.tagged_vlans %}
  switchport trunk allowed vlan {{ iface.tagged_vlans }}
{% endif %}
  spanning-tree port type edge trunk
  no logging event port link-status
  mtu 9216
{% if iface.qos is defined and iface.qos %}
  priority-flow-control mode on
  service-policy type qos input AZLOCAL-QOS-MAP
{% endif %}
{% if iface.shutdown is defined and iface.shutdown %}
  shutdown
{% else %}
  no shutdown
{% endif %}

{% endfor %}
{%- endif %}
